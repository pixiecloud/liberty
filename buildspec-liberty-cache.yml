version: 0.2

# Liberty Feature Cache Builder Pipeline
# This pipeline downloads Liberty, caches features, and publishes to CodeArtifact

# PREREQUISITES:
# 1. CodeArtifact domain 'bcbsnc' must exist
# 2. CodeArtifact repository 'liberty-artifacts' must exist
# 3. CodeBuild role must have CodeArtifact permissions (see below)

# TO ADD CODEARTIFACT PERMISSIONS TO CODEBUILD ROLE:
# aws iam put-role-policy \
#   --role-name codebuild-liberty-base-image-builder-service-role \
#   --policy-name CodeArtifactAccess \
#   --policy-document '{
#     "Version": "2012-10-17",
#     "Statement": [
#       {
#         "Effect": "Allow",
#         "Action": ["codeartifact:*"],
#         "Resource": "*"
#       },
#       {
#         "Effect": "Allow",
#         "Action": ["sts:GetServiceBearerToken"],
#         "Resource": "*",
#         "Condition": {
#           "StringEquals": {
#             "sts:AWSServiceName": "codeartifact.amazonaws.com"
#           }
#         }
#       }
#     ]
#   }'

env:
  variables:
    LIBERTY_VERSION: "26.0.0.1"
    CODEARTIFACT_DOMAIN: "bcbsnc"
    CODEARTIFACT_REPO: "liberty-artifacts"
    NAMESPACE: "liberty"
    AWS_DEFAULT_REGION: "us-east-1"

phases:
  pre_build:
    commands:
      - echo "Phase 1 - Verifying prerequisites..."
      - echo "CodeArtifact Domain=$CODEARTIFACT_DOMAIN"
      - echo "CodeArtifact Repository=$CODEARTIFACT_REPO"
      - echo "Liberty Version=$LIBERTY_VERSION"
      - echo "Prerequisites checked. Proceeding with build..."

  build:
    commands:
      - echo "Phase 2 - Downloading Liberty $LIBERTY_VERSION..."
      - mkdir -p /tmp/liberty-build
      - cd /tmp/liberty-build
      
      # Download Liberty
      - wget https://public.dhe.ibm.com/ibmdl/export/pub/software/websphere/wasdev/downloads/wlp/$LIBERTY_VERSION/wlp-javaee8-$LIBERTY_VERSION.zip
      - unzip wlp-javaee8-$LIBERTY_VERSION.zip
      - cd wlp
      
      - echo "Phase 3 - Downloading features to local cache..."
      - |
        ./bin/installUtility download --location=./feature-cache --acceptLicense \
          beanValidation-2.0 \
          cdi-2.0 \
          jaxrs-2.1 \
          jdbc-4.2 \
          jndi-1.0 \
          jpa-2.2 \
          mpMetrics-3.0 \
          mpHealth-3.0
      
      - echo "Phase 4 - Creating feature cache archive..."
      - tar -czf liberty-feature-cache-$LIBERTY_VERSION.tar.gz feature-cache/
      
      - echo "Phase 5 - Calculating SHA256 hash..."
      - HASH=$(sha256sum liberty-feature-cache-$LIBERTY_VERSION.tar.gz | awk '{print $1}')
      - echo "Hash = $HASH"
      
      - echo "Phase 6 - Publishing to CodeArtifact..."
      - |
        aws codeartifact publish-package-version \
          --domain $CODEARTIFACT_DOMAIN \
          --repository $CODEARTIFACT_REPO \
          --format generic \
          --namespace $NAMESPACE \
          --package liberty-feature-cache \
          --package-version $LIBERTY_VERSION \
          --asset-name liberty-feature-cache-$LIBERTY_VERSION.tar.gz \
          --asset-content liberty-feature-cache-$LIBERTY_VERSION.tar.gz \
          --asset-sha256 $HASH

  post_build:
    commands:
      - echo "Phase 7 - Verifying upload..."
      - |
        aws codeartifact describe-package-version \
          --domain $CODEARTIFACT_DOMAIN \
          --repository $CODEARTIFACT_REPO \
          --format generic \
          --namespace $NAMESPACE \
          --package liberty-feature-cache \
          --package-version $LIBERTY_VERSION
      
      - echo "âœ… Liberty feature cache $LIBERTY_VERSION successfully published to CodeArtifact!"
      - echo ""
      - echo "Teams can now download it in their buildspec.yml using:"
      - echo "  aws codeartifact get-package-version-asset \\"
      - echo "    --domain $CODEARTIFACT_DOMAIN \\"
      - echo "    --repository $CODEARTIFACT_REPO \\"
      - echo "    --format generic \\"
      - echo "    --namespace $NAMESPACE \\"
      - echo "    --package liberty-feature-cache \\"
      - echo "    --package-version $LIBERTY_VERSION \\"
      - echo "    --asset liberty-feature-cache-$LIBERTY_VERSION.tar.gz \\"
      - echo "    liberty-feature-cache.tar.gz"

artifacts:
  files:
    - '**/*'
  name: liberty-feature-cache-build-$(date +%Y%m%d-%H%M%S)
